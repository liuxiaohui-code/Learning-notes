# 事务

![1635733145176](../photo/mysql事务.png)

## 1. 语法

1. `start transaction;` `begin;`
2. `commit;` 使得当前的修改确认
3. `rollback; `使得当前的修改被放弃
4. `savepoint <xxx>` 保留点
   1. `rollback to xxx` 回退到保留点
   2. 保留点在事务提交或回退后自动释放,也可以通过`release savepoint` 手动释放
5. `set autocommit=0` 取消自动提交,为 1 是开启

## 2. 事务的 ACID 特性

1. 原⼦性（Atomicity）
   事务的原⼦性是指事务必须是⼀个原子的操作序列单元。事务中包含的各项操作在⼀次执⾏过程中，只
   允许出现两种状态之一。
   （1）全部执行成功
   （2）全部执行失败
   事务开始后所有操作，要么全部做完，要么全部不做，不可能停滞在中间环节。事务执⾏过程中出错，
   会回滚到事务开始前的状态，所有的操作就像没有发⽣一样。也就是说事务是⼀个不可分割的整体，就
   像化学中学过的原子，是物质构成的基本单位。
2. ⼀致性（Consistency）
   事务的一致性是指事务的执⾏不能破坏数据库数据的完整性和一致性，一个事务在执⾏之前和执行之
   后，数据库都必须处以⼀致性状态。
   比如：如果从 A 账户转账到 B 账户，不可能因为 A 账户扣了钱，⽽ B 账户没有加钱。
3. 隔离性（Isolation）
   事务的隔离性是指在并发环境中，并发的事务是互相隔离的。也就是说，不同的事务并发操作相同的数
   据时，每个事务都有各自完整的数据空间。
   ⼀个事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务是不能互相干扰的。
   隔离性分 4 个级别，下面会介绍。
4. 持久性（Duration）
   事务的持久性是指事务⼀旦提交后，数据库中的数据必须被永久的保存下来。即使服务器系统崩溃或服
   务器宕机等故障。只要数据库重新启动，那么一定能够将其恢复到事务成功结束后的状态

## 3. 事务的并发问题

- **脏读**：读取到了没有提交的数据, 事务 A 读取了事务 B 更新的数据，然后 B 回滚操作，那么 A 读取到的 数据是脏数据。
- **不可重复读**：同⼀条命令返回不同的结果集（更新）.事务 A 多次读取同一数据，事务 B 在事务 A 多次读取的过程中，对数据做了更新并提交，导致事务 A 多次读取同一数据时，结果不一致。
- **幻读**：重复查询的过程中，数据就发⽣了量的变化（insert， delete）。

## 4. 事务的隔离等级

​ 4 种事务隔离级别从上往下，级别越高，并发性越差，安全性就越来越高。 ⼀般数据默认级别是 读以提交或可重复读。

```sql
# 查看当前会话中事务的隔离级别
select @@tx_isolation;
# 设置当前会话中的事务隔离级别
set session transaction isolation level read uncommitted;
```

1. 读未提交（READ_UNCOMMITTED）
   读未提交，该隔离级别允许脏读取，其隔离级别是最低的。换句话说，如果一个事务正在处理理某一数
   据，并对其进⾏了更新，但同时尚未完成事务，因此还没有提交事务；而以此同时，允许另一个事务也
   能够访问该数据。
2. 读已提交（READ_COMMITTED）
   读已提交是不同的事务执行的时候只能获取到已经提交的数据。 这样就不会出现上面的脏读的情况了。
   但是在同一个事务中执行同一个读取,结果不一致
   不可重复读示例
   可是解决了脏读问题，但是还是解决不了可重复读问题。
3. 可重复读（REPEATABLE_READ）
   可重复读就是保证在事务处理理过程中，多次读取同一个数据时，该数据的值和事务开始时刻是一致的。
   因此该事务级别限制了不可重复读和脏读，但是有可能出现幻读的数据。
   幻读
   幻读就是指同样的事务操作，在前后两个时间段内执行对同一个数据项的读取，可能出现不一致的结果。
   诡异的更新事件
4. 顺序读（SERIALIZABLE）
   顺序读是最严格的事务隔离级别。它要求所有的事务排队顺序执⾏行行，即事务只能一个接一个地处理，不
   能并发。

## 5. 不同的隔离级别的锁的情况(了解)

1. 读未提交（RU）: 有行级的锁，没有间隙锁。它与 RC 的区别是能够查询到未提交的数据。

2. 读已提交（RC）：有行级的锁，没有间隙锁，读不到没有提交的数据。

3. 可重复读（RR）：有行级的锁，也有间隙锁，每次读取的数据都是一样的，并且没有幻读的情况。

4. 序列化（S）：有行级锁，也有间隙锁，读表的时候，就已经上锁了

## 6. 隐式提交(了解)

DQL:查询语句句

DML:写操作(添加,删除,修改)

DDL:定义语句句(建库,建表,修改表,索引操作,存储过程,视图)

DCL:控制语⾔言(给⽤用户授权,或删除授权)

DDL（Data Define Language）：都是隐式提交。

隐式提交：执⾏行行这种语句句相当于执⾏行行 commit; DDL